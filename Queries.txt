# To extract the orders awaiting to be canceled

select DISTINCT o.ORDER_REF,SIEBEL_VERSION,ORDER_STATUS,FOM_ORDER_STATUS,to_char(o.LAST_MODIFIED_DATE,'DD/MM/YYYY HH:MI:SS') LAST_MODIFIED_DATE,PLANID,nvl(TASKS_BEFORE_CANCELLATION,0)TASKS_BEFORE_CANCELLATION,nvl(HAS_ACTIVE_CANCELLATION_TASKS,0) HAS_ACTIVE_CANCELLATION_TASKS,WO.ORDER_FULFIL_ID,WO.STATUS,WO.SUB_STATUS,ACTION_TYPE
from (
    select ORDER_REF,SIEBEL_VERSION,ORDER_STATUS,LAST_MODIFIED_DATE,FOM_ORDER_STATUS,PLANID
    from ei_orders join (select ORDERREF ORDER_REF,STATUS FOM_ORDER_STATUS,PLANID from orders@EAI_TIBCO_FOM) using (order_ref)
    where ORDER_STATUS = 'Cancel In Progress' and LAST_MODIFIED_DATE < trunc(SYSDATE) - 30) o
join (select * from EI_WORK_ORDERS WO
      WHERE WO.ID >=All (select ID from EI_WORK_ORDERS WO1 where WO.ORDER_REF=WO1.ORDER_REF and ACTION_TYPE='OrderCancellation')
and ACTION_TYPE='OrderCancellation'
) WO on (o.ORDER_REF=WO.ORDER_REF)
left outer join (
    select concat('1-',REGEXP_SUBSTR(custom_task_id,'\d+',1,2)) ORDER_REF,nvl(PRT_PROCESS_INSTANCE_ID,'nulll') PRT_PROCESS_INSTANCE_ID,count(*) TASKS_BEFORE_CANCELLATION from EAIPROCOM_105.t_task t1
    where status =1
    group by concat('1-',REGEXP_SUBSTR(custom_task_id,'\d+',1,2)),PRT_PROCESS_INSTANCE_ID
) tt1 on (o.ORDER_REF=tt1.ORDER_REF and PRT_PROCESS_INSTANCE_ID <> WO.ORDER_FULFIL_ID)
left outer join (
    select t1.PRT_PROCESS_INSTANCE_ID,count(*) HAS_ACTIVE_CANCELLATION_TASKS from EAIPROCOM_105.t_task t1
    WHERE status =1
    group by PRT_PROCESS_INSTANCE_ID
)tt2 ON (tt2.PRT_PROCESS_INSTANCE_ID=WO.ORDER_FULFIL_ID)
WHERE (TASKS_BEFORE_CANCELLATION is not null OR HAS_ACTIVE_CANCELLATION_TASKS IS NULL)
and WO.LAST_MODIFIED_DATE < sysdate-1/24;



# To cancel them on EAI DB

update ei_orders set ORDER_STATUS = 'Cancelled', FAILURE_REASON = 'manual updated to cancelled' 
where order_ref in ('1-1161254073769',
'1-1161587305626',
'1-1158986111607',
'1-1161306775908',
'1-1161249561549',
'1-1161591510053',
'1-1161277571354',
'1-1161272355460',
'1-1161580273750',
'1-1158582540014',
'1-1158659018331',
'1-1157873625832',
'1-1161274405595',
'1-1161280458353',
'1-1161649752158',
'1-1161277571354',
'1-1150802294998',
'1-1145703466679',
'1-1153093857395',
'1-1147853941286',
'1-1161284967930',
'1-1161274788374',
'1-1161287220035',
'1-1158808740406',
'1-1159115538995',
'1-1157527895765',
'1-1161591510053',
'1-1161680233214',
'1-1161658568815',
'1-1161280746952',
'1-1161312621887',
'1-1161254073769',
'1-1161307356391',
'1-1161273185828',
'1-1146355257202',
'1-1152903169952',
'1-1161291580365',
'1-1161657564209',
'1-1161274405595',
'1-1161259269133',
'1-1161274788374',
'1-1161292315077',
'1-1161284967930',
'1-1159080655060',
'1-1152644708764',
'1-1147993717263',
'1-1140893665029',
'1-1148844288918',
'1-1161296205957',
'1-1161273185828',
'1-1155506993227',
'1-1161268803932',
'1-1161706461395',
'1-1158960247158',
'1-1161296205957',
'1-1161259269133',
'1-1161607039028',
'1-1161268803932',
'1-1161264549522',
'1-1161292233204',
'1-1158571535794',
'1-1158298659765',
'1-1162014397100',
'1-1155516345870',
'1-1161713160896',
'1-1158991952638',
'1-1161306775908',
'1-1161292315077',
'1-1161586276085',
'1-1161280458353',
'1-1161287220035',
'1-1161292233204',
'1-1155134120544',
'1-1148121180827',
'1-1154349477993',
'1-1161267111053',
'1-1161309574497',
'1-1159333445357',
'1-1162014397100',
'1-1159195579268',
'1-1161279852013',
'1-1161587305626',
'1-1161267111053',
'1-1151193054160',
'1-1151923161108',
'1-1161649752158',
'1-1161657564209',
'1-1161279852013',
'1-1161586276085',
'1-1161249561549',
'1-1161264549522',
'1-1161280746952',
'1-1161291580365',
'1-1161272355460',
'1-1147963914364',
'1-1150708643892');


# Then we cancel them on Siebel DB, First the line items

update siebel.s_order_item set  status_cd = 'Cancelled' ,  processed_FLG= 'N' 
where order_id in ( select row_id  from siebel.s_order where order_num in ('1-1161254073769',
'1-1161587305626',
'1-1158986111607',
'1-1161306775908',
'1-1161249561549',
'1-1161591510053',
'1-1161277571354',
'1-1161272355460',
'1-1161580273750',
'1-1158582540014',
'1-1158659018331',
'1-1157873625832',
'1-1161274405595',
'1-1161280458353',
'1-1161649752158',
'1-1161277571354',
'1-1150802294998',
'1-1145703466679',
'1-1153093857395',
'1-1147853941286',
'1-1161284967930',
'1-1161274788374',
'1-1161287220035',
'1-1158808740406',
'1-1159115538995',
'1-1157527895765',
'1-1161591510053',
'1-1161680233214',
'1-1161658568815',
'1-1161280746952',
'1-1161312621887',
'1-1161254073769',
'1-1161307356391',
'1-1161273185828',
'1-1146355257202',
'1-1152903169952',
'1-1161291580365',
'1-1161657564209',
'1-1161274405595',
'1-1161259269133',
'1-1161274788374',
'1-1161292315077',
'1-1161284967930',
'1-1159080655060',
'1-1152644708764',
'1-1147993717263',
'1-1140893665029',
'1-1148844288918',
'1-1161296205957',
'1-1161273185828',
'1-1155506993227',
'1-1161268803932',
'1-1161706461395',
'1-1158960247158',
'1-1161296205957',
'1-1161259269133',
'1-1161607039028',
'1-1161268803932',
'1-1161264549522',
'1-1161292233204',
'1-1158571535794',
'1-1158298659765',
'1-1162014397100',
'1-1155516345870',
'1-1161713160896',
'1-1158991952638',
'1-1161306775908',
'1-1161292315077',
'1-1161586276085',
'1-1161280458353',
'1-1161287220035',
'1-1161292233204',
'1-1155134120544',
'1-1148121180827',
'1-1154349477993',
'1-1161267111053',
'1-1161309574497',
'1-1159333445357',
'1-1162014397100',
'1-1159195579268',
'1-1161279852013',
'1-1161587305626',
'1-1161267111053',
'1-1151193054160',
'1-1151923161108',
'1-1161649752158',
'1-1161657564209',
'1-1161279852013',
'1-1161586276085',
'1-1161249561549',
'1-1161264549522',
'1-1161280746952',
'1-1161291580365',
'1-1161272355460',
'1-1147963914364',
'1-1150708643892') and rev_num = 1);


# Then we cancel the header items

update siebel.s_order set status_cd = 'Cancelled' , active_flg ='N' where order_num in ('1-1161254073769',
'1-1161587305626',
'1-1158986111607',
'1-1161306775908',
'1-1161249561549',
'1-1161591510053',
'1-1161277571354',
'1-1161272355460',
'1-1161580273750',
'1-1158582540014',
'1-1158659018331',
'1-1157873625832',
'1-1161274405595',
'1-1161280458353',
'1-1161649752158',
'1-1161277571354',
'1-1150802294998',
'1-1145703466679',
'1-1153093857395',
'1-1147853941286',
'1-1161284967930',
'1-1161274788374',
'1-1161287220035',
'1-1158808740406',
'1-1159115538995',
'1-1157527895765',
'1-1161591510053',
'1-1161680233214',
'1-1161658568815',
'1-1161280746952',
'1-1161312621887',
'1-1161254073769',
'1-1161307356391',
'1-1161273185828',
'1-1146355257202',
'1-1152903169952',
'1-1161291580365',
'1-1161657564209',
'1-1161274405595',
'1-1161259269133',
'1-1161274788374',
'1-1161292315077',
'1-1161284967930',
'1-1159080655060',
'1-1152644708764',
'1-1147993717263',
'1-1140893665029',
'1-1148844288918',
'1-1161296205957',
'1-1161273185828',
'1-1155506993227',
'1-1161268803932',
'1-1161706461395',
'1-1158960247158',
'1-1161296205957',
'1-1161259269133',
'1-1161607039028',
'1-1161268803932',
'1-1161264549522',
'1-1161292233204',
'1-1158571535794',
'1-1158298659765',
'1-1162014397100',
'1-1155516345870',
'1-1161713160896',
'1-1158991952638',
'1-1161306775908',
'1-1161292315077',
'1-1161586276085',
'1-1161280458353',
'1-1161287220035',
'1-1161292233204',
'1-1155134120544',
'1-1148121180827',
'1-1154349477993',
'1-1161267111053',
'1-1161309574497',
'1-1159333445357',
'1-1162014397100',
'1-1159195579268',
'1-1161279852013',
'1-1161587305626',
'1-1161267111053',
'1-1151193054160',
'1-1151923161108',
'1-1161649752158',
'1-1161657564209',
'1-1161279852013',
'1-1161586276085',
'1-1161249561549',
'1-1161264549522',
'1-1161280746952',
'1-1161291580365',
'1-1161272355460',
'1-1147963914364',
'1-1150708643892') and rev_num = 1;