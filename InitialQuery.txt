select DISTINCT o.ORDER_REF,SIEBEL_VERSION,ORDER_STATUS,FOM_ORDER_STATUS,to_char(o.LAST_MODIFIED_DATE,'DD/MM/YYYY HH:MI:SS') LAST_MODIFIED_DATE,PLANID,nvl(TASKS_BEFORE_CANCELLATION,0)TASKS_BEFORE_CANCELLATION,nvl(HAS_ACTIVE_CANCELLATION_TASKS,0) HAS_ACTIVE_CANCELLATION_TASKS,WO.ORDER_FULFIL_ID,WO.STATUS,WO.SUB_STATUS,ACTION_TYPE
from (
    select ORDER_REF,SIEBEL_VERSION,ORDER_STATUS,LAST_MODIFIED_DATE,FOM_ORDER_STATUS,PLANID
    from ei_orders join (select ORDERREF ORDER_REF,STATUS FOM_ORDER_STATUS,PLANID from orders@EAI_TIBCO_FOM) using (order_ref)
    where ORDER_STATUS = 'Cancel In Progress' and LAST_MODIFIED_DATE < trunc(SYSDATE) - 30) o
join (select * from EI_WORK_ORDERS WO
      WHERE WO.ID >=All (select ID from EI_WORK_ORDERS WO1 where WO.ORDER_REF=WO1.ORDER_REF and ACTION_TYPE='OrderCancellation')
and ACTION_TYPE='OrderCancellation'
) WO on (o.ORDER_REF=WO.ORDER_REF)
left outer join (
    select concat('1-',REGEXP_SUBSTR(custom_task_id,'\d+',1,2)) ORDER_REF,nvl(PRT_PROCESS_INSTANCE_ID,'nulll') PRT_PROCESS_INSTANCE_ID,count(*) TASKS_BEFORE_CANCELLATION from EAIPROCOM_105.t_task t1
    where status =1
    group by concat('1-',REGEXP_SUBSTR(custom_task_id,'\d+',1,2)),PRT_PROCESS_INSTANCE_ID
) tt1 on (o.ORDER_REF=tt1.ORDER_REF and PRT_PROCESS_INSTANCE_ID <> WO.ORDER_FULFIL_ID)
left outer join (
    select t1.PRT_PROCESS_INSTANCE_ID,count(*) HAS_ACTIVE_CANCELLATION_TASKS from EAIPROCOM_105.t_task t1
    WHERE status =1
    group by PRT_PROCESS_INSTANCE_ID
)tt2 ON (tt2.PRT_PROCESS_INSTANCE_ID=WO.ORDER_FULFIL_ID)
WHERE (TASKS_BEFORE_CANCELLATION is not null OR HAS_ACTIVE_CANCELLATION_TASKS IS NULL)
and WO.LAST_MODIFIED_DATE < sysdate-1/24;